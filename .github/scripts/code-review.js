const { Octokit } = require('@octokit/rest');
const { Anthropic } = require('@anthropic-ai/sdk');

// Configuration
const CONFIG = {
  maxFiles: 10,
  maxFileSize: 3000, // characters
  excludePatterns: [
    'node_modules',
    'dist',
    'build',
    '.next',
    'coverage',
    '*.min.js',
    '*.min.css',
    'package-lock.json',
    'yarn.lock',
    '*.log'
  ]
};

// Initialize clients
const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });

/**
 * Get PR files and changes
 */
async function getPRFiles(owner, repo, prNumber) {
  const { data: files } = await octokit.rest.pulls.listFiles({
    owner,
    repo,
    pull_number: prNumber,
  });

  return files
    .filter(file => {
      // Filter by file size and patterns
      const changes = file.patch || '';
      const isExcluded = CONFIG.excludePatterns.some(pattern =>
        file.filename.includes(pattern)
      );
      return !isExcluded && changes.length > 0;
    })
    .slice(0, CONFIG.maxFiles)
    .map(file => ({
      filename: file.filename,
      status: file.status,
      additions: file.additions,
      deletions: file.deletions,
      changes: file.changes,
      patch: file.patch?.slice(0, CONFIG.maxFileSize) || ''
    }));
}

/**
 * Create review prompt for Claude
 */
function createReviewPrompt(files, prTitle, prDescription) {
  const filesSummary = files.map(f =>
    `## ${f.filename} (${f.status})
\`\`\`diff
${f.patch}
\`\`\``
  ).join('\n\n');

  return `You are a code reviewer. Review the following pull request changes.

PR Title: ${prTitle}
PR Description: ${prDescription || 'No description provided'}

# Files Changed
${filesSummary}

Please provide a structured code review with:
1. **Summary**: Brief overview of changes
2. **Issues**: Any bugs, security issues, or problems found (with file:line references)
3. **Suggestions**: Improvements or best practices recommendations
4. **Positive**: What was done well

Format your response in markdown with clear sections.`;
}

/**
 * Call Claude API for code review
 */
async function reviewWithClaude(prompt) {
  try {
    const message = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 4000,
      messages: [{
        role: 'user',
        content: prompt
      }]
    });

    return message.content[0].text;
  } catch (error) {
    console.error('Claude API error:', error);
    throw error;
  }
}

/**
 * Post review comment to PR
 */
async function postReviewComment(owner, repo, prNumber, reviewBody) {
  const comment = `## ü§ñ AI Code Review

${reviewBody}

---
*This review was generated by [Claude](https://www.anthropic.com/claude)*`;

  await octokit.rest.issues.createComment({
    owner,
    repo,
    issue_number: prNumber,
    body: comment
  });

  console.log('‚úÖ Review comment posted successfully');
}

/**
 * Main function
 */
async function main() {
  const { PR_NUMBER, REPO_OWNER, REPO_NAME } = process.env;

  if (!PR_NUMBER || !REPO_OWNER || !REPO_NAME) {
    console.error('‚ùå Missing required environment variables');
    process.exit(1);
  }

  try {
    console.log(`üîç Starting code review for PR #${PR_NUMBER}...`);

    // Get PR details
    const { data: pr } = await octokit.rest.pulls.get({
      owner: REPO_OWNER,
      repo: REPO_NAME,
      pull_number: parseInt(PR_NUMBER),
    });

    console.log(`üìù PR: ${pr.title}`);
    console.log(`üë§ Author: ${pr.user.login}`);
    console.log(`üåø Branch: ${pr.head.ref} ‚Üí ${pr.base.ref}`);

    // Get changed files
    const files = await getPRFiles(REPO_OWNER, REPO_NAME, parseInt(PR_NUMBER));
    console.log(`üìÅ Found ${files.length} files to review`);

    if (files.length === 0) {
      console.log('‚úÖ No files to review');
      return;
    }

    // Create review prompt
    const prompt = createReviewPrompt(files, pr.title, pr.body);

    // Get AI review
    console.log('ü§ñ Requesting AI review...');
    const review = await reviewWithClaude(prompt);

    // Post review as comment
    await postReviewComment(REPO_OWNER, REPO_NAME, parseInt(PR_NUMBER), review);

    console.log('‚úÖ Code review completed successfully');
  } catch (error) {
    console.error('‚ùå Error during code review:', error.message);
    process.exit(1);
  }
}

main();
